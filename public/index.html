<!DOCTYPE html>
<html>
<head>
  <script src="/js/tailwind.min.js"></script>
</head>
<body class="bg-gray-100 p-8">

<h1 class="text-2xl font-bold mb-4">ExternalSSD Process Manager</h1>

<div class="space-x-4 mb-4">
  <button onclick="dryRun()"
          class="bg-blue-600 text-white px-4 py-2 rounded">
    Dry Run
  </button>

  <button onclick="runCleanup()"
          class="bg-red-600 text-white px-4 py-2 rounded">
    Run Cleanup
  </button>
</div>

<table class="w-full bg-white shadow rounded">
  <thead class="bg-gray-200">
  <tr>
    <th class="p-2">PID</th>
    <th>Command</th>
    <th>User</th>
    <th>Action</th>
  </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
  async function dryRun() {
    showBanner("⏳ Performing dry run...", "yellow");
    const res = await fetch("/api/dry-run");
    render(await res.json());
    showBanner("ℹ️ This is a dry run. No processes were terminated.", "yellow");
  }

  async function runCleanup() {
    showBanner("⏳ Running cleanup...", "yellow");
    const res = await fetch("/api/run", { method: "POST" });
    const data = await res.json();
    render(data);
    showStatus(data);
  }

  function render(data) {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    data.processes.forEach(p => {
      tbody.innerHTML += `
      <tr class="border-b">
        <td class="p-2">${p.pid}</td>
        <td>${p.command}</td>
        <td>${p.user}</td>
        <td class="${p.action === 'terminate' ? 'text-red-600' : 'text-gray-500'}">
          ${p.action}
        </td>
      </tr>`;
    });
  }

  function showStatus(data) {
    if (data.unmountSuccess && !data.forceEjectUsed) {
      showBanner("✅ ExternalSSD ejected safely", "green");
    }

    if (data.forceEjectUsed) {
      showBanner("⚠ Force eject used (safe, but not clean)", "yellow");
    }

    if (!data.unmountSuccess && data.unmountAttempted) {
      showBanner("❌ Eject failed — reboot may be required", "red");
    }
  }

  function showBanner(message, color) {
    // remove existing banners
    document.querySelectorAll(".banner").forEach(b => b.remove());
    // create new banner
    const banner = document.createElement("div");
    banner.className = `banner p-4 mb-4 text-white rounded ${
        color === "green" ? "bg-green-600" :
            color === "yellow" ? "bg-yellow-600" :
                "bg-red-600"
    }`;
    banner.innerText = message;
    // add a click listener on cross icon to close the banner
    const closeIcon = document.createElement("span");
    closeIcon.innerHTML = "&times;";
    closeIcon.className = "float-right cursor-pointer font-bold";
    banner.appendChild(closeIcon);
    document.body.insertBefore(banner, document.body.firstChild);
    closeIcon.onclick = () => banner.remove();
  }
</script>

</body>
</html>
